# AI Recipe Insights Feature

## Overview

The AI Recipe Insights feature uses OpenAI's GPT-4o-mini model to automatically generate culinary insights for recipes. These insights provide users with additional information about flavor combinations, nutritional benefits, cooking tips, or what makes the recipe special.

## Implementation Details

### Architecture

The feature is implemented with:

1. **Backend**:
   - OpenAI API integration via the Node.js SDK
   - Database storage of generated insights
   - On-demand generation for existing recipes
   - Auto-generation for newly created recipes

2. **Frontend**:
   - Display component for showing AI insights below recipe descriptions
   - Styled UI with clear AI attribution

### Database Schema

The `Recipe` model includes an `ai_insight` field:

```javascript
ai_insight: { 
  type: DataTypes.TEXT, 
  allowNull: true 
}
```

This field stores the AI-generated text and is exposed through the recipe API.

### OpenAI Service

A dedicated service module handles API communication with OpenAI:

```javascript
// backend/src/services/openaiService.js

const generateRecipeInsight = async (title, description, ingredients, difficulty, mealType) => {
  try {
    const prompt = `
      Generate a brief 2-3 sentence insight about the following recipe. 
      Include interesting observations about flavor combinations, nutritional benefits, or culinary tips.
      Keep it concise and helpful for home cooks. Highlight what makes this recipe special.
      
      Recipe Title: ${title}
      Description: ${description || 'No description provided'}
      Ingredients: ${ingredients || 'Ingredients not specified'}
      Difficulty: ${difficulty}
      Meal Type: ${mealType}
    `;

    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: "You are a helpful culinary assistant providing brief insights about recipes. Keep your responses to 2-3 sentences maximum."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 150
    });

    return response.choices[0].message.content.trim();
  } catch (error) {
    console.error('Error generating recipe insight:', error);
    return "Could not generate insight for this recipe.";
  }
};
```

### Recipe Controller Logic

The recipe controller handles:

1. Checking if a recipe already has insights
2. Generating insights for recipes that don't have them
3. Updating insights when recipe details change

Key implementation in `getRecipeById`:

```javascript
// If recipe doesn't have an AI insight yet, generate one and update the recipe
if (!plainRecipe.ai_insight) {
  try {
    const ingredientsText = recipe.Ingredients ? 
      recipe.Ingredients.map(ing => ing.name).join(', ') : '';
    
    const insight = await openaiService.generateRecipeInsight(
      recipe.title,
      recipe.description,
      ingredientsText,
      recipe.difficulty,
      recipe.meal_type
    );
    
    // Update recipe with the new insight
    await Recipe.update(
      { ai_insight: insight },
      { where: { id: recipe.id } }
    );
    
    // Add the insight to the response
    plainRecipe.ai_insight = insight;
  } catch (insightError) {
    console.error('Error generating recipe insight:', insightError);
    // Continue without insight if generation fails
  }
}
```

### Frontend Display

The insight is displayed in a styled container below the recipe description:

```jsx
{recipe.ai_insight && (
  <div className="recipe-ai-insight">
    <h2>AI Chef Insights</h2>
    <p className="ai-insight-text">{recipe.ai_insight}</p>
    <div className="ai-badge">Generated by AI</div>
  </div>
)}
```

## Insight Generation Strategy

The application uses a dual approach for generating AI insights:

1. **During Recipe Creation**: Insights are generated as part of the recipe creation process
2. **On-Demand Fallback**: If a recipe is viewed that doesn't have an insight (e.g., if API call failed during creation), it will be generated on-the-fly

This approach ensures:
- All recipes have insights regardless of when they were created
- The system is resilient against API failures
- Unnecessary API calls are avoided by storing insights in the database
- Users see consistent AI features throughout the application

The check in `getRecipeById` serves as a safety net:

```javascript
// If recipe doesn't have an AI insight yet, generate one and update the recipe
if (!plainRecipe.ai_insight) {
  try {
    const ingredientsText = recipe.Ingredients ? 
      recipe.Ingredients.map(ing => ing.name).join(', ') : '';
    
    const insight = await openaiService.generateRecipeInsight(
      recipe.title,
      recipe.description,
      ingredientsText,
      recipe.difficulty,
      recipe.meal_type
    );
    
    // Update recipe with the new insight
    await Recipe.update(
      { ai_insight: insight },
      { where: { id: recipe.id } }
    );
    
    // Add the insight to the response
    plainRecipe.ai_insight = insight;
  } catch (insightError) {
    console.error('Error generating recipe insight:', insightError);
    // Continue without insight if generation fails
  }
}
```

## Integration with Recipe Creation

When implementing the Recipe Creation page, follow these steps to ensure AI insights are automatically generated:

### Backend Integration

1. Create a new controller endpoint for recipe creation
2. After saving the new recipe to the database, but before returning the response, generate AI insights
3. Update the recipe with the generated insights

```javascript
// Example implementation for recipe creation endpoint
exports.createRecipe = async (req, res) => {
  const userId = req.user.id; // From auth middleware
  const { title, description, steps, ingredients, /* other recipe fields */ } = req.body;
  
  const transaction = await sequelize.transaction();
  
  try {
    // 1. Create the basic recipe
    const newRecipe = await Recipe.create({
      id: uuidv4(),
      title,
      description,
      steps,
      /* other recipe fields */
      user_id: userId,
    }, { transaction });
    
    // 2. Process and associate ingredients
    // ... ingredient creation code here ...
    
    // 3. Generate AI insight
    const ingredientsText = ingredients.map(ing => ing.name).join(', ');
    const insight = await openaiService.generateRecipeInsight(
      title,
      description,
      ingredientsText,
      difficulty,
      meal_type
    );
    
    // 4. Update recipe with insight
    await Recipe.update(
      { ai_insight: insight },
      { where: { id: newRecipe.id } },
      { transaction }
    );
    
    // 5. Commit transaction
    await transaction.commit();
    
    // 6. Get the complete recipe with insight to return
    const completeRecipe = await Recipe.findByPk(newRecipe.id, {
      include: [/* relevant includes */],
    });
    
    return res.status(201).json(completeRecipe);
  } catch (error) {
    await transaction.rollback();
    console.error('Error creating recipe:', error);
    return res.status(500).json({ message: 'Server error creating recipe' });
  }
};
```

### Frontend Integration

For the Recipe Creation form:

1. Create a form with all necessary recipe fields (title, description, ingredients, etc.)
2. On form submission, send data to the backend creation endpoint
3. Display loading state during submission
4. Upon successful creation, redirect to the recipe details page where insights will be visible

```jsx
// Example form submission handler
const handleSubmit = async (e) => {
  e.preventDefault();
  setSubmitting(true);
  
  try {
    const recipeData = {
      title,
      description,
      steps: stepsArray.join('\n'),
      ingredients: ingredientArray,
      // other recipe fields
    };
    
    const response = await createRecipe(recipeData, token);
    
    // Redirect to the newly created recipe's details page
    // The AI insight will be visible there
    navigate(`/recipes/${response.id}`);
  } catch (error) {
    console.error('Error creating recipe:', error);
    setError('Failed to create recipe. Please try again.');
  } finally {
    setSubmitting(false);
  }
};
```

## Environment Setup

To use the OpenAI integration, add the following to your `.env` file in the backend directory:

```
OPENAI_API_KEY=your_openai_api_key
```

> ⚠️ **Important**: Never commit your API key to version control. Ensure `.env` is in your `.gitignore` file.

## Cost Considerations

The implementation follows a cost-efficient approach:

1. Insights are generated only once per recipe and stored in the database
2. The GPT-4o-mini model offers a balance of quality and cost-effectiveness
3. Token limits are set to control costs
4. Error handling ensures the application works even if AI generation fails

Current OpenAI pricing for GPT-4o-mini (as of April 2025):
- Input tokens: $0.15 per million tokens
- Output tokens: $0.60 per million tokens

## Troubleshooting

Common issues:

1. **Missing API Key**: Ensure the `OPENAI_API_KEY` is properly set in your `.env` file
2. **API Rate Limits**: If generating insights for many recipes at once, you might hit rate limits
3. **Model Name Changes**: If OpenAI updates model names, update the `model` parameter in `openaiService.js`

## Future Enhancements

Potential future improvements:

1. Add user feedback mechanism for AI insights (helpful/not helpful)
2. Implement caching to improve performance
3. Allow custom insight prompts based on recipe type
4. Add multilingual support for insights
5. Explore utilizing recipe images for more context-aware insights 